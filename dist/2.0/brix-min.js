/*! Brix - v2.0
* https://github.com/etaoux/brix
* Copyright (c) 2012 etaoux; Licensed MIT */
KISSY.add("brix/core/tmpler",function(a,b,c){function e(a,b){this.tmpls=[],a&&b!==!1?this._praseTmpl(a,b):this.tmpl=a}var d=c.all;return a.extend(e,Object,{_praseTmpl:function(a,b){var c=this,e=!1,f,g;if(typeof a=="string"){if(a.charAt(0)==="."||a.charAt(0)==="#"||a==="body")f=d(a)}else f=a;f&&(f.item(0)[0].nodeName.toUpperCase()=="SCRIPT"?a=f.item(0).html():e=!0);if(!e){var h="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']?([^\"'\\s]+)[\"']?\\s+[^>]*?bx-datakey=[\"']?([^\"'\\s]+)[\"']?[^>]*?>(@brix@)</\\1>";while(b--)h=h.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");h=h.replace("@brix@","(?:[\\s\\S]*?)"),c.reg=h,c.tmpl=c._replaceTmpl(a),c._buildTmpls(c.tmpl)}c.inDom=e},_buildTmpls:function(a){var b=this,c=new RegExp(b.reg,"ig"),d;while((d=c.exec(a))!==null)b.tmpls.push({name:d[2],datakey:d[3],tmpler:new e(d[4],!1)}),b._buildTmpls(d[4])},_replaceTmpl:function(b){var c=/<!--bx-tmpl="([^"]+?)"\s+bx-datakey="([^"]+?)"-->(\s*([\s\S]*)?\s*)<!--bx-tmpl="\1"-->/g,d,e=function(b,c,d,e){return a.log(b+","+e),e};while(c.test(b))b=b.replace(c,e),c.lastIndex=0;return b},addTmpl:function(a,b,c){var d=this;d.tmpls.push({name:a,datakey:b,tmpler:new e(c,!1)})},getTmpl:function(){return this.tmpl},to_html:function(a){return(new b(this.getTmpl())).render(a)}}),e},{requires:["xtemplate","node","sizzle"]}),KISSY.add("brix/core/dataset",function(a,b){function c(){c.superclass.constructor.apply(this,arguments)}return c.ATTRS={data:{}},a.extend(c,b,{setRenderer:function(a,b,c){var d=this,e=d.get("data"),f,g;c=c?c+"_":"";if(a){var h=function(d,f){var g=c+d+"_"+f,h=a[d][f];e[g]=function(){return h.call(this,b,d)}};for(f in a)for(g in a[f])h(f,g)}}}),c},{requires:["base"]}),KISSY.add("brix/core/chunk",function(a,b,c,d,e,f){function h(){h.superclass.constructor.apply(this,arguments);var a=this,b=a.get("tmpl");if(b){a._buildTmpler(b,a.get("level"));var c=a.get("tmpler");c&&(a._buildDataset(a.get("data")),c.inDom&&a.set("el",b))}}var g=b.all;return h.ATTRS={el:{getter:function(b){return a.isString(b)&&(b=g(b)),b}},isRemoveHTML:{value:!0},isRemoveEl:{value:!0},container:{value:"body",getter:function(b){return a.isString(b)&&(b=g(b)),b}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3}},a.extend(h,d,{_buildTmpler:function(a,b){var c=this;if(!c.get("isBuidTmpler")){c.set("isBuidTmpler",!0);var d=new f(a,b);c.set("tmpler",d)}},_buildDataset:function(b){var c=this;if(!c.get("isBuidDataset")){c.set("isBuidDataset",!0),b=b||{},b=a.clone(b);var d=new e({data:b});c.set("dataset",d),d.on("afterDataChange",function(a){c._render(a.subAttrName,a.newVal)})}},_destroy:function(){var a=this,b=a.get("tmpler"),c=a.get("dataset");b&&(a.set("tmpler",null),delete b.tmpls),c&&(a.set("dataset",null),c.detach())},addTmpl:function(a,b,c){var d=this;d._buildTmpler("",!1),d._buildDataset();var e=d.get("tmpler");e.addTmpl(a,b,c)},setChunkData:function(b,c,d){var e=this,f=e.get("dataset");f&&(c=a.clone(c),f.set("data."+b,c,d))},render:function(){var a=this;if(!a.get("rendered")){var b=a.get("dataset");b&&a._render("data",b.get("data")),a.set("rendered",!0),a.fire("rendered")}},_render:function(d,e){var f=this,h=f.get("tmpler");if(h)if(d.split(".").length>1)f.get("rendered")&&(d=d.replace(/^data\./,""),f._renderTmpl(h.tmpls,d,e));else if(!h.inDom){var i=f.get("container"),j=f.get("el"),k=a.trim(h.to_html(e)),l;if(!j||j.length===0){var m="brix_"+a.guid();if(c.ie<=8){l=new b("<div />"),i.append(l),l.html(k);var n=l[0].childNodes;if(n.length>1)l.attr("id",m);else{m=n[0].id||m,n[0].id=m;while(n.length>0)i[0].appendChild(n[0]);l.remove(),l=null}}else l=new b(k),l.length>1?l=g('<div id="'+m+'"></div>').append(l):(m=l.attr("id")||m,l.attr("id",m)),i.append(l);f.set("el","#"+m)}else if(c.ie<=8){l=new b("<div />"),i.append(l),l.html(k);while(l[0].childNodes.length>0)i[0].appendChild(l[0].childNodes[0]);l.remove(),l=null}else i.append(k)}},_renderTmpl:function(b,c,d){var e=this,f=e.get("el");a.each(b,function(b){if((","+b.datakey+",").indexOf(","+c+",")>=0){var g=f.all("[bx-tmpl="+b.name+"]");f.attr("bx-tmpl")==b.name&&(g=f.add(g)),g.each(function(c){if(c.attr("bx-datakey")==b.datakey){var f={};a.each(b.datakey.split(","),function(a){var b=d,c=a.split("."),e=c.length,g=0;while(g!==e)b=b[c[g]],g++;f[c[e-1]]=b,b=null}),a.each(d,function(b,c){a.isFunction(b)&&(f[c]=b)}),e.fire("beforeRefreshTmpl",{node:c}),c.html(a.trim(b.tmpler.to_html(f))),e.fire("afterRefreshTmpl",{node:c}),f=null}}),g=null}})}}),h},{requires:["node","ua","base","./dataset","./tmpler"]}),KISSY.add("brix/core/brick",function(a,b){function c(b,c){return a.isString(c)?b[c]:c}function d(){var a=this;a.pagelet=arguments[0]?arguments[0].pagelet:null,d.superclass.constructor.apply(this,arguments);var b=a.constructor;while(b.NAME!="Brick"){var c=b.RENDERERS;c&&(a._buildTmpler("",!1),a._buildDataset(),a.get("dataset").setRenderer(c,a)),b=b.superclass.constructor}a.on("rendered",function(){var c,d=[];b=a.constructor;while(b.NAME!="Brick")b.prototype.hasOwnProperty("initialize")&&(c=b.prototype.initialize)&&d.push(c),b=b.superclass.constructor;for(var e=d.length-1;e>=0;e--)d[e]&&d[e].call(a);a._bindEvent()});var e=a.get("tmpler");(a.get("autoRender")||!e||e.inDom)&&a.render()}return d.NAME="Brick",a.extend(d,b,{initialize:function(){},destructor:function(){},_detachEvent:function(){var b=this,c=b.constructor;while(c.NAME!="Brick"){var d=c.EVENTS;d&&b._removeEvents(d);var e=c.DOCEVENTS;e&&b._removeEvents(e,a.one(document)),c=c.superclass.constructor}b._undelegateEvents();var f=b.get("events");f&&this._removeEvents(f)},_bindEvent:function(){var b=this,c=b.constructor;while(c.NAME!="Brick"){var d=c.EVENTS;d&&this._addEvents(d);var e=c.DOCEVENTS;e&&this._addEvents(e,a.one(document)),c=c.superclass.constructor}b._delegateEvents();var f=b.get("events");f&&this._addEvents(f)},_removeEvents:function(a,b){b=b||this.get("el");for(var d in a){var e=a[d];for(var f in e){var g=c(this,e[f]);d===""?b.detach(f,g,this):b.undelegate(f,d,g,this)}}},_addEvents:function(a,b){b=b||this.get("el");for(var d in a){var e=a[d];for(var f in e){var g=c(this,e[f]);d===""?b.on(f,g,this):b.delegate(f,d,g,this)}}},_delegateEvents:function(){var a=this.events,b=this.get("el")[0],c=this,d=function(a){b["on"+a]=function(){var b=arguments[0]||window.event,d=b.target||b.srcElement;d.nodeType!==1&&(d=d.parentNode);var e=d.getAttribute("bx"+a);if(e){var f=e.split("|"),g,h;for(var i=0;i<f.length;i++){g=f[i].split(":"),h=g.shift();var j=g[g.length-1],k=!1;if(j==="_halt_"||j==="_preventDefault_")b.preventDefault?b.preventDefault():b.returnValue=!1,k=!0;if(j==="_halt_"||j==="_stop_")b.stopPropagation?b.stopPropagation():b.cancelBubble=!0,k=!0;k&&g.pop(),c.events&&c.events[a]&&c.events[a][h]&&c.events[a][h].call(c,d,g)}}d=null}};for(var e in a)d(e)},_undelegateEvents:function(){var a=this.events,b=this.get("el")[0],c=this,d=function(a){b["on"+a]=null};for(var e in a)d(e)},destroy:function(){var a=this;a._destroy(),a.get("rendered")&&a._detachEvent();var b=a.constructor;while(b.NAME!="Brick")b.prototype.hasOwnProperty("destructor")&&b.prototype.destructor.apply(a),b=b.superclass.constructor;if(a.get("rendered")&&a.get("isRemoveHTML")){var c=a.get("el");a.get("isRemoveEl")?c.remove():c.empty()}a.pagelet&&delete a.pagelet,a.detach()}}),d},{requires:["./chunk"]}),KISSY.add("brix/core/pagelet",function(a,b){function c(b,c){return c=c||"brick_",b.attr("id")||b.attr("id",a.guid("brix_"+c)),b.attr("id")}function d(){d.superclass.constructor.apply(this,arguments);var a=this;a.isReady=!1,a.readyList=[],a.bricks=[],a.isAddBehavior=!1;if(a.get("autoRender")||a.get("tmpler").inDom)a.on("rendered",function(){var b=a.get("callback");b&&typeof b=="function"&&a.ready(b),a.get("behavior")&&a.addBehavior()}),a.render()}return d.ATTRS={behavior:{value:!0},callback:{value:null}},a.extend(d,b,{getBrick:function(b){var c=this,d;return a.each(c.bricks,function(a){if(a.id===b)return d=a.brick,!1}),d||null},addBehavior:function(){var a=this;if(a.get("rendered")&&!a.isAddBehavior){a.isAddBehavior=!0;var b=a.get("el"),c=b.all("[bx-name]");b.hasAttr("bx-name")&&(c=b.add(c)),a._addBehavior(c,function(b){a.bricks=b,a._fireReady(),a.on("beforeRefreshTmpl",function(b){b.node.all("[bx-name]").each(function(b){a.destroy(b.attr("id"))})}),a.on("afterRefreshTmpl",function(b){a._addBehavior(b.node.all("[bx-name]"),function(b){b.length>0&&(a.bricks=a.bricks.concat(b))})})})}},_addBehavior:function(b,d){var e=this,f=[];b.each(function(a){var b=c(a),d=a.attr("bx-name"),e=a.attr("bx-path"),g=a.attr("bx-config");g=g?(new Function("return "+g))():{},f.push({id:b,name:d,path:e,config:g})});if(f.length>0){var g=[];a.each(f,function(b){b.path||(b.path="brix/gallery/"+b.name+"/"),a.inArray(g,b.path)||g.push(b.path)}),a.use(g.join(","),function(a){var b=arguments;a.each(f,function(c){var d=c.id,f=a.merge({container:"#"+d,el:"#"+d,pagelet:e},c.config),h=b[a.indexOf(c.path,g)+1],i=new h(f);c.brick=i}),b=null,d(f)})}else d(f)},ready:function(a){this.isReady?a.call(window,this):this.readyList.push(a)},_fireReady:function(){var a=this;if(a.isReady)return;a.isReady=!0;if(a.readyList){var b,c=0;while(b=a.readyList[c++])b.call(a);a.readyList=null}},destroy:function(b){var c=this;if(b)for(var d=0;d<c.bricks.length;d++){var e=c.bricks[d];if(b===e.id)return c._destroyBrick(e),c.bricks.splice(d,1),!1}else{c._destroy(),a.each(c.bricks,function(a,b){c._destroyBrick(a)}),c.bricks=null;if(c.get("rendered")&&c.get("isRemoveHTML")){var f=c.get("el");c.get("isRemoveEl")?f.remove():f.empty(),f=null}c.detach()}},_destroyBrick:function(a){a.brick&&(a.brick.destroy&&a.brick.destroy(),a.brick=null)}}),d},{requires:["./chunk"]}),KISSY.add("brix/core/demolet",function(a,b,c){function d(b,d,e){e=e||"@",d=d||{};var f=new RegExp("\\{\\{"+e+"(.+)?\\}\\}","ig");return b=b.replace(f,function(b,e){a.log(e);var f="",g=e.replace(/\//ig,"_").replace(/\./ig,"_");return d[g]=d[g]||{},c({url:e+"template.html",dataType:"html",async:!1,success:function(a,b,c){f="{{#"+g+"}}"+a+"{{/"+g+"}}"}}),c({url:e+"data.json",async:!1,dataType:"json",success:function(a,b,c){for(var e in a)d[g][e]=a[e]}}),f}),{tmpl:b,data:d}}function e(){e.superclass.constructor.apply(this,arguments)}return e.ATTRS={s:{value:"@"},tmpl:{setter:function(a){var b=this,c=b.get("data")||{},e=d(a,c,b.get("s"));return b.set("data",e.data),e.tmpl}}},a.extend(e,b,{}),e},{requires:["./pagelet","ajax"]}),function(a,b){function i(b){b=a.trim(b),b&&b.charAt(b.length-1)!="/"&&(b+="/"),!b.match(/^(http(s)?)|(file):/i)&&!g(b,"/")&&(b=h+b);if(g(b,"/")){var c=e.location;b=c.protocol+"//"+c.host+b}var d=b.split("/"),f=[],i;for(var j=0;j<d.length;j++)i=d[j],i!="."&&(i==".."?f.pop():f.push(i));return b=f.join("/"),b.substring(0,b.length-1)}function j(){var b=/^(.*)brix(-min)?\.js[^\/]*/i,c=/brix(-min)?\.js/i,d=e.document.getElementsByTagName("script"),f=d[d.length-1],g=i(f.src),h=f.getAttribute("bx-config");h?h=(new Function("return "+h))():h={},h.comboPrefix=h.comboPrefix||"??",h.comboSep=h.comboSep||",";var j=h.comboPrefix,k=h.comboSep,l=g.split(k),m,n=l[0],o,p=n.indexOf(j);return p==-1?m=g.replace(b,"$1"):(m=n.substring(0,p),o=n.substring(p+2,n.length),o.match(c)?m+=o.replace(b,"$1"):a.each(l,function(a){if(a.match(c))return m+=a.replace(b,"$1"),!1})),m=m.substring(0,m.lastIndexOf("brix")),a.mix({autoConfig:!0,path:m,componentsPath:"./",importsPath:"./"},h)}var c=!1,d=[],e=window,f=e.location,g=a.startsWith,h=f.href.replace(f.hash,"").replace(/[^\/]*$/i,"");b=e[b]=e[b]||{};var k=j(),l="",m="20121226",n="2.0",o=!1;a.mix(b,{config:function(c){if(o)return;o=!0,c=a.merge({debug:l=="@DEBUG@"?!0:!1,tag:m=="@TAG@"?"":m,fixed:n=="@VERSION@"?"":n+"/",gallery:{}},k,c),c.fixed=="@VERSION@"&&(c.fixed=""),b.basePath=c.path,b.fixed=c.fixed,a.config({packages:[{name:"brix",path:c.path,tag:c.tag,charset:"utf-8"},{name:"components",path:c.componentsPath,tag:c.componentsTag||c.tag,charset:"utf-8"},{name:"imports",path:c.importsPath,tag:c.importsTag||c.tag,charset:"utf-8"}]}),a.config({map:[[/(.+brix\/)(gallery\/)(.+?)(\/.+?(?:-min)?\.(?:js|css))(\?[^?]+)?$/,function(a,b,d,e,f,g){var h=b+c.fixed+d+e;return c.gallery[e]&&(h+="/"+c.gallery[e]),c.debug&&(f=f.replace("-min","")),h+=f+(g?g:""),h}],[/(.+brix\/)(core.+?)((?:-min)?\.js)(\?[^?]+)?$/,function(a,b,d,e,f){var g=b+c.fixed;return c.debug&&(e=e.replace("-min","")),g+=d+e+(f?f:""),g}]]})},ready:function(a){c?a.call(b):d.push(a)},_fireReady:function(){if(c)return;c=!0;if(d){var a,e=0;while(a=d[e++])a.call(b);d=null}}});if(k.autoConfig){b.config({});if(k.autoPagelet){a.use("brix/core/pagelet",function(a,c){a.ready(function(){b.pagelet=new c({tmpl:"body"}),b._fireReady()})});return}}a.ready(function(){b._fireReady()})}(KISSY,"Brix");